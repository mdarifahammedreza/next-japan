name: CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      - name: Run lint & tests
        run: |
          npm run lint
          npm test || echo "No tests found"

      - name: Build project
        run: npm run build

      - name: Build Docker image
        run: docker build -t meemjarrin/next-japan:latest .

      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push Docker image
        run: docker push meemjarrin/next-japan:latest
# --- Continuous Deployment (CD) Step for Kubernetes ---
      # (Optional Bonus Mark)
      - name: ðŸš€ CD: Deploy to Kubernetes on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          # Ensure these secrets are correctly set in GitHub repository settings
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu # Default for Ubuntu EC2
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # port: 22 # Default port, can be omitted
          
          # Command to update the deployment on the EC2 cluster
          script: |
            echo "Starting Kubernetes deployment update in 'ostad' namespace..."
            
            # Use 'kubectl set image' to trigger a rolling update
            # This forces Kubernetes to pull the new 'latest' image
            kubectl set image deployment/next-japan-deployment next-japan-app=meemjarrin/next-japan:latest -n ostad
            
            # Wait for the rollout to complete before finishing the job
            kubectl rollout status deployment/next-japan-deployment -n ostad
            
            echo "Deployment successfully updated."
